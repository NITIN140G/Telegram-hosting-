# ===================== CONFIG =====================

BOT_TOKEN = ""
OPENAI_API_KEY = ""

OWNER_ID = 123456789  # PASTE YOUR TELEGRAM USER ID HERE

# ==================================================

from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

from openai import OpenAI
import time

# ===================== AI =====================

client = OpenAI(api_key=OPENAI_API_KEY)

# ===================== MEMORY =====================

MEMORY_LIMIT = 6
user_memory = {}

def add_memory(uid, role, content):
    if uid not in user_memory:
        user_memory[uid] = []
    user_memory[uid].append({"role": role, "content": content})
    user_memory[uid] = user_memory[uid][-MEMORY_LIMIT:]

def get_memory(uid):
    return user_memory.get(uid, [])

def reset_memory(uid):
    user_memory.pop(uid, None)

# ===================== USERS =====================

banned_users = set()
last_message_time = {}

def rate_limited(uid, seconds=3):
    now = time.time()
    if uid in last_message_time and now - last_message_time[uid] < seconds:
        return True
    last_message_time[uid] = now
    return False

# ===================== COMMANDS =====================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ¤– AI Bot Online\n\nJust send a message to chat."
    )

async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "/start - Start bot\n"
        "/help - Commands\n"
        "/reset - Clear memory\n"
        "/ban <id> - Ban user (owner)\n"
        "/unban <id> - Unban user (owner)"
    )

async def reset_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    reset_memory(update.effective_user.id)
    await update.message.reply_text("â™»ï¸ Memory cleared")

async def ban_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != OWNER_ID:
        return
    if not context.args:
        await update.message.reply_text("Usage: /ban user_id")
        return
    banned_users.add(int(context.args[0]))
    await update.message.reply_text("ğŸš« User banned")

async def unban_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != OWNER_ID:
        return
    if not context.args:
        await update.message.reply_text("Usage: /unban user_id")
        return
    banned_users.discard(int(context.args[0]))
    await update.message.reply_text("âœ… User unbanned")

# ===================== CHAT =====================

async def chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id

    if uid in banned_users:
        return

    if rate_limited(uid):
        await update.message.reply_text("â³ Slow down")
        return

    user_text = update.message.text

    add_memory(uid, "user", user_text)

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=get_memory(uid)
        )

        reply = response.choices[0].message.content
        add_memory(uid, "assistant", reply)

        await update.message.reply_text(reply)

    except Exception as e:
        await update.message.reply_text("âŒ AI Error")

# ===================== MAIN =====================

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("reset", reset_cmd))
    app.add_handler(CommandHandler("ban", ban_cmd))
    app.add_handler(CommandHandler("unban", unban_cmd))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, chat))

    print("ğŸ¯ğŸ¯ğŸ¯ğŸ¯AI Bot is running...")
    app.run_polling()

if __name__ == "__main__":
    main()
    
